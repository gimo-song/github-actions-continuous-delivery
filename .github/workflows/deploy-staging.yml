name: StagingUpdate
on:
  push:
    branches:
      - 'SERVICE-sgm*'
env:
  WORK_DIR: cd /root/sites/wishket.com/source
  REMOVE_DOCKER: docker rm -f $(docker ps -a -q --filter="name=${GITHUB_REF##*/}")
  KILL_GUNICORN: pkill -e gunicorn

  SET_REF: GITHUB_REF=${{ github.ref }};

  GIT_FETCH: git fetch origin
  GIT_CHECKOUT: git checkout ${GITHUB_REF##*/}
  GIT_PULL: git pull

  START_GUNICORN: sudo ~/.pyenv/versions/service/bin/gunicorn -c gunicorn.py wishket.wsgi:application &> /dev/null &
  COPY_STATIC_FOLDER: cp -r /root/sites/wishket.com/source/wishket/static/ /root/sites/wishket.com/
  DOCKER_SET: /root/.pyenv/versions/service/bin/fab docker_set:t,t

  START_PYLINT: /root/.pyenv/versions/source/bin/pip install pylint

  PYLINT_START: pylint **/*.py

jobs:
  pylint:
    name: Start lint in local
    runs-on: macOS Big Sur 11.0
    steps:
      - name: Start pylint
        uses: cclauss/GitHub-Action-for-pylint@0.7.0
        with:
          args: pip install . ; pylint **/*.py"

  jslint:
    name: Start js lint in local

  htmllint:
    name: Start html lint in local

  build:
    name: staging update
    runs-on: ubuntu-16.04
    steps:
    - name: Start staging update
      uses: fifsky/ssh-action@master
      with:
        command: |
          ${{ env.SET_REF }}
          ${{ env.WORK_DIR }}
        host: ssh.sgm.wishdev.net
        user: root
        key: ${{ secrets.GITHUB_ACTION_KEY }}
